= Nevermore Controller
:toc: macro
:toclevels: 2

A Pi Pico W based controller for https://github.com/nevermore3d/Nevermore_Max[Nevermore Max] and
https://github.com/nevermore3d/StealthMax[StealthMax] filters.
This controller is BlueTooth LE enabled, minimising required wiring and allowing multiple clients
to interact with the controller.

toc::[]

== Features

* [x] Klipper Module
* [x] BLE - Multiple Connections Supported
* [x] Fan - Tachometer
* [x] Fan - Control - Automatic
* [x] Fan - Control - Override
* [x] Sensor - BME280 (Temperature, Humidity, Pressure)
* [x] Sensor - HTU2xD (Temperature, Humidity)
* [x] Sensor - SGP40 (Volatile Organic Compound Index)
* [x] WS2812 support
* [ ] Display - GC9A01


== Build Requirements

* Pico-W SDK 1.5.1+
* CMake 3.20+
* C++23 compiler, e.g. GCC 12+ (tested w/ 12.2.1)

== Installation For Dummies

NOTE: Make sure you meet the xref:klipper-requirements[Klipper requirements].

Instructions:

. Build or download the controller `uf2` binaries, flash to Pico W.
+
The Pico W's LED should start flashing once the controller has booted.

. Execute the following to install the Klipper module:
+
```sh
cd ~
git clone git@github.com:SanaaHamel/nevermore-controller.git
cd nevermore-controller
./install-klipper-module.bash
```

. Update your printer config. Here's a xref:klipper-config-minimal[trivial configuration example], and xref:klipper-config-full[see here for complete documentation].

. Check your printer's log file. If everything went well you should see something like:
+
```log
... BLAH
... BLAH
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (283 moves)
... BLAH
... BLAH
[11:27:13:976834] nevermore - discovered controller 28:CD:C1:09:64:8F
[11:27:13:981190] nevermore - connected to controller 28:CD:C1:09:64:8F
... BLAH
... BLAH
```


== Customisation & Pin Assignments

`src/config.hpp` contains all user-customisable options.
These options are, for the most part, validated at compile time to prevent mistakes.

Pins assignments can be modified to suit your board/wiring, but are subject to hardware-related constraints. These are constraints are extensively checked at compile time, and will result in a (hopefully) useful error message if violated. If it compiles, it's a valid configuration.

WARNING: GPIO 0 and 1 are currently hardcoded for UART. They cannot be used in any pin assignments.

== Klipper

[#klipper-requirements]
=== Requirements

* Klipper using Python 3.7+
* Kiauh-like installation (required by installation script)

TL;DR: If you installed everything using https://github.com/th33xitus/kiauh[Kiauh], you should be good to go so long as you installed Klipper with Python 3.

=== Configuration

[#klipper-config-minimal]
==== Minimal Example

This example configuration is suitable quickly getting up and running.

```ini
[nevermore]
# BOM states a 16 pixel
led_colour_order: GBR
led_chain_count: 16

[temperature_sensor nevermore_intake]
sensor_type: NevermoreSensor
sensor_kind: intake
class_name_override: bme280

[temperature_sensor nevermore_exhaust]
sensor_type: NevermoreSensor
sensor_kind: exhaust
class_name_override: bme280

[temperature_sensor nevermore_intake_VOC]
sensor_type: NevermoreSensor
sensor_kind: intake
plot_voc: true
```


[#klipper-config-full]
==== Full Documentation

```ini
[nevermore]
# Optional - Can omit if you have only one nevermore in range.
# See <<Finding The BT Address>> for more info.
# example - `bt_address: 43:43:A2:12:1F:AC`
# bt_address: <REPLACE WITH YOUR BT DEVICE ADDRESS>

# Optional - LED
# For the optional LED ring feature.
# Members generally behaves like the WS2812 klipper module.
# (e.g. supports heterogenous pixel chains)
led_colour_order: GBR
led_chain_count: 16

# Optional - Fan Policy
# Controls how/when the fan turns on automatically.
# Values given here are also the defaults.

# seconds, how long to keep filtering after the policy would otherwise stop
fan_policy_cooldown: 900
# voc index, 0 to disable, filter if any sensor meets this threshold
fan_policy_voc_passive_max: 125
# voc index, 0 to disable, filter if the intake exceeds exhaust by at least this much
fan_policy_voc_improve_min: 5


[temperature_sensor nevermore_sensor]
sensor_type: NevermoreSensor

# required - valid values: `intake`, `exhaust`
sensor_kind: intake

# optional
# If you do not wish to edit your mainsail installation to add `NevermoreSensor`,
# to its list of known sensors, you can use an already recognised classname (e.g. `bme280`)
class_name_override: bme280

# optional - default: false
# Pretends the VOC index is a temperature, allowing it to be plotted in Mainsail/Fluidd.
# Setting this to true will suppress the all other readings for this sensor object. (e.g. temperature, pressure, etc)
plot_voc: true


# led-effects are supported, here's an example:
[led_effect panel_idle]
autostart:              true
frame_rate:             24
leds:
    nevermore
layers:
    comet  1 0.5 add (0.0, 0.0, 0.0),(1.0, 0.0, 0.0),(1.0, 1.0, 0.0),(1.0, 1.0, 1.0)
    breathing  2 1 top (0,.25,0)
```


=== Finding The BT Address

**If you have only one Nevermore controller in range then you can omit the `bt_address` option in your printer configuration and ignore this section entirely.**

If you have multiple BlueTooth devices in range that look like candidates for a Nevermore controller, then you have to specify which one to use.

NOTE: It is possible, but very rare, for the address to change when a new `uf2` is flashed onto the Pico. This has been observed once after updating the Pico SDK.

==== Method A - Check the Klipper Log

An error will be raised if there are multiple controllers in range.
The error message will list all the available controllers' addresses.

Pick one from the list and stuff that into the `nevermore` section's `bt_address`.

For example, given this log:

```log
...
...
[11:06:36:535560] nevermore - multiple nevermore controllers discovered.
specify which to use by setting `bt_address: <insert-address-here>` in your klipper config.
discovered controllers (ordered by signal strength):
    address           | signal strength
    -----------------------------------
    FA:KE:AD:RE:SS:01 | -38 dBm
    FA:KE:AD:RE:SS:00 | -57 dBm
Config error
Traceback (most recent call last):
  File "~/klipper/klippy/klippy.py", line 180, in _connect
    cb()
  File "~/klipper/klippy/extras/nevermore.py", line 793, in _handle_connect
    raise self.printer.config_error("nevermore failed to connect - timed out")
configparser.Error: nevermore failed to connect - timed out
...
...
```

We could use `bt_address: FA:KE:AD:RE:SS:01` or `bt_address: FA:KE:AD:RE:SS:00`.

In this case I'd plug in `FA:KE:AD:RE:SS:01` since that device has the strongest signal, i.e. closest-ish to the Klipper host.


==== Method B - Use Your Phone + nRF Connect

WARNING: If you're hosting Klipper on MacOS then you cannot use this approach and must use <<Method A - Check the Klipper Log>>.

nRF Connect is an app by Nordic Semi.
It's meant for debugging/exploring BLE devices, but we can (ab)use to find the BT addresses.

Load the app, scan for BLE devices. The controllers will all be named "Nevermore", and their BT addresses will be listed below.

.nRF Connect displays device names & addresses
image::README-nrf-connect.png[nRC Connect Screenshot,256]


=== Fan Control & Macros

There are two modes of operation:

* Automatic - Fan power is managed by the controller based on its fan policy (xref:klipper-config-full[see here]).

* Manual - Fan power is overridden and will run at the specified power until the override is cleared.

From within Klipper, the fan can be controlled much like any other fan:

```gcode
; override automatic fan control, full speed ahead
SET_FAN_SPEED FAN=nevermore_fan SPEED=1
; not specifying `SPEED=` disables fan override and returns to automatic fan control
SET_FAN_SPEED FAN=nevermore_fan
```


You could therefore alter your `print_start` macro to force the fan to start before the VOC sensors detect anything, and clear the override in `print_end` to allow automatic control to mop up on its own.

WARNING: Setting the fan speed to 0 in Mainsail/Fluidd UI does **not** clear the control override. It just sets it to zero. (i.e. disables the fan)

== Credits

* https://github.com/julianschill/klipper-led_effect[Julian Schill] - installation script (derived)
* https://github.com/boschsensortec/BME280_driver[Bosch Sensors] - BME280 library (included)
* https://github.com/Sensirion/gas-index-algorithm[Sensirion] - SGP40 gas index library (included)
* https://github.com/0ndsk4[0ndsk4] - Donated hardware for testing
