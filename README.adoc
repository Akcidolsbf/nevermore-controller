
Nevermore Controller
====================

A Pi Pico W based controller for https://github.com/nevermore3d/Nevermore_Max[Nevermore Max] and
https://github.com/nevermore3d/StealthMax[StealthMax] filters.
This controller is BlueTooth LE enabled, minimising required wiring and allowing multiple clients
to interact with the controller.

*BUILD REQUIRES PATCH FOR PICO SDK BUG - See below.*

Features
--------

* [x] Klipper Module
* [x] BLE - Multiple Connections Supported
* [x] Fan - Tachometer
* [x] Fan - Control - Automatic
* [x] Fan - Control - Override
* [x] Sensor - BME280 (Temperature, Humidity, Pressure)
* [x] Sensor - HTU2xD (Temperature, Humidity)
* [x] Sensor - SGP40 (Volatile Organic Compound Index)
* [x] WS2812 support
* [ ] Display - GC9A01

Klipper - Example Configuration
-------------------------------

```ini
[nevermore]
# example - `bt_address: 43:43:A2:12:1F:AC`
bt_address: <REPLACE WITH YOUR BT DEVICE ADDRESS>
# LED members are optional and generally behaves like the WS2812 klipper module
# (e.g. supports heterogenous pixel chains)
led_colour_order: GBR
led_chain_count: 16

# All fan policy settings are optional. Values given here are also the defaults.

# seconds, how long to keep filtering after the policy would otherwise stop
fan_policy_cooldown: 900
# voc index, 0 to disable, filter if any sensor meets this threshold
fan_policy_voc_passive_max: 125
# voc index, 0 to disable, filter if the intake exceeds exhaust by at least this much
fan_policy_voc_improve_min: 5

[temperature_sensor nvm0_intake]
sensor_type: NevermoreSensor
sensor_kind: intake
# If you do not wish to edit your mainsail installation to add `NevermoreSensor`,
# to its list of known sensors, you can use an already recognised classname (e.g. `bme280`)
class_name_override: bme280

# If you wish the VOC index levels plotted, this can be hacked in by pretending the
# VOC index is a temperature by using `plot_voc: true`
[temperature_sensor nvm0_intake_VOC]
sensor_type: NevermoreSensor
sensor_kind: intake
plot_voc: true

[temperature_sensor nvm1_exhaust]
sensor_type: NevermoreSensor
sensor_kind: exhaust

# led-effects are supported
[led_effect panel_idle]
autostart:              true
frame_rate:             24
leds:
    nevermore
layers:
    comet  1 0.5 add (0.0, 0.0, 0.0),(1.0, 0.0, 0.0),(1.0, 1.0, 0.0),(1.0, 1.0, 1.0)
    breathing  2 1 top (0,.25,0)
```


Klipper - Fan Control & Macros
------------------------------

The fan can be controlled much like any other fan.


```gcode
; override automatic fan control, full speed ahead
SET_FAN_SPEED FAN=nevermore_fan SPEED=1
; not specifying `SPEED=` disables fan override and returns to automatic fan control
SET_FAN_SPEED FAN=nevermore_fan
```


You could therefore alter your `print_start` macro to force the fan to start before the VOC sensors detect anything, and clear the override in `print_end` to allow automatic control to mop up on its own.

WARNING: Setting the fan speed to 0 in Mainsail/Fluidd UI does **not** clear the control override. It just sets it to zero. (i.e. disables the fan)


Build Requirements
------------------

* Pico-W SDK 1.5.1+
* CMake 3.20+
* GCC 12+ (tested w/ 12.2.1, support for constexpr `std::bit_cast` required)

Credits
-------

* https://github.com/julianschill/klipper-led_effect[Julian Schill] - installation script (derived)
* https://github.com/boschsensortec/BME280_driver[Bosch Sensors] - BME280 library (included)
* https://github.com/Sensirion/gas-index-algorithm[Sensirion] - SGP40 gas index library (included)
* https://github.com/0ndsk4[0ndsk4] - Donated hardware for testing
